---
title: "Programacion con R"
output: html_notebook
---

```{r}
library(tidyverse)
```


## Leer multiples archivos

Filtrar el listado de archivos que contienen los datos

```{r}
archivos <- list.files(pattern = "datos_")

archivos
```

Utilize `map()` para leer todos los archivos y despues recibir un solo objecto tipo lista.

```{r}
map(archivos, read_csv)
```

Con `bind_rows()`, cortesia de `dplyr`, se pueden combinar los datos dentro de la lista en una sola tabla.

```{r}
map(archivos, read_csv) %>% 
  bind_rows()
```

`map_df()` permite hacer esos dos pasos en un solo comando. Es muy conveniente en muchos casos, pero en este caso hace falta la identificacion de los grados.

```{r}
map_df(archivos, read_csv)
```

## Preparar multiples archivos

Utilizar `~` y `.x` de la funcion `map()` resulta en el mismo resultado.  Tambien podemos utilizar el `%>%` 

```{r}
archivos %>%
  map(~read_csv(.x))
```

La differencia es que ahora podemos pasar mas de un comando. En este caso, re-utilizamos el nombre del archivo para crear una nueva variable.

```{r}
archivos %>%
  map(~read_csv(.x) %>% mutate(origen = .x))
```

Igual que en las seccion anterior, usamos `bind_rows()` para crear una sola tabla.

```{r}
archivos %>%
  map(~read_csv(.x) %>% mutate(origen = .x)) %>%
  bind_rows()
```
```{r}
archivos %>%
  map(~read_csv(.x) %>% mutate(origen = .x)) %>%
  bind_rows() %>%
    mutate(
    grado = str_remove(origen, "datos_"),
    grado = str_remove(grado, "_grado.csv")
  )
```

Los resultados los podemos grabar en una variable.

```{r}
datos <- list.files(pattern = "datos_") %>%
  map(~read_csv(.x) %>% mutate(origen = .x)) %>%
  bind_rows() %>%
    mutate(
    grado = str_remove(origen, "datos_"),
    grado = str_remove(grado, "_grado.csv")
  )

datos
```

https://resources.rstudio.com/espanol/2018-05-23-13-01-usando-r-para-la-ciencia-de-datos-edgar-ruiz-edited

```{r}
datos_limpios <- datos %>%
  separate(nombre, into = c("apellido", "primer")) %>% 
  separate(fecha, into = c("dia", "mes", "aÃ±o"), convert = TRUE) %>% 
  gather("materia", "puntos", "matematica", "ingles")

datos_limpios
```

## `map()` y tablas

`map()` considera tablas, como `tibble`s y `data.frame`s, como operaciones de columnas y no lineas.  

```{r}
datos_limpios %>%
  group_by(matricula, primer, apellido) %>%
  summarise() %>%
  map(~.x)
```

Usualmente, es necesario correr los ciclos por cada linea y no columna.  Para eso, podemos utilizar `transpose()`.

```{r}
estudiantes <- datos_limpios %>%
  group_by(matricula, primer, apellido) %>%
  summarise() %>%
  transpose() 

estudiantes[1]
```

https://resources.rstudio.com/espanol/comunicando-resultados-con-r-edgar-ruiz

```{r}
library(rmarkdown)

map(estudiantes, ~ 
    render(
      "reporte_tarjetas.Rmd", 
      params = list(matricula = .x$matricula),
      output_file = paste0(.x$matricula, "-", .x$primer, "-", .x$apellido, ".html"),
      output_dir = "tarjetas",
      quiet = TRUE
      )
)

```
